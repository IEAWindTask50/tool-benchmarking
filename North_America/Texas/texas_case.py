# -*- coding: utf-8 -*-
"""texas_case.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1P5xckSP20X9UHSuYn8p7DxqfH8Y-V3nO
"""

import time
import numpy as np
import pandas as pd
import os
import yaml
import matplotlib.pyplot as plt

from hydesign.assembly.hpp_assembly import hpp_model
from hydesign.examples import examples_filepath

os.chdir(os.path.dirname(__file__))

sites = pd.read_csv('hopp_input/34.22_-102.75_psmv3_60_2013.csv', index_col=0)
example = 0

ex_site = sites.iloc[int(example),:]

print('Selected example site:')
print('---------------------------------------------------')
print(ex_site.T)

longitude = float(ex_site['Longitude'])
latitude = float(ex_site['Latitude'])
altitude = float(ex_site['Elevation'])
input_ts_fn = os.path.join(os.getcwd(), 'hydesign_input/input_ts_texas.csv')
sim_pars_fn = os.path.join(os.getcwd(), 'hydesign_input/hpp_pars_converted.yml')

hpp = hpp_model(
        sim_pars_fn,
        latitude = latitude,
        longitude = longitude,
        altitude = altitude,
        num_batteries = 10,
        work_dir = './',
        input_ts_fn = input_ts_fn,
        save_battry_rf_filename='battery_rf.csv',
)

with open(sim_pars_fn, 'r') as f:
    sim_pars = yaml.safe_load(f)

inputs = dict(
clearance = sim_pars['hh'] - sim_pars['d'] / 2,
sp = (4 * sim_pars['p_rated'] * 1e6) / (np.pi * (sim_pars['d'] ** 2)),
p_rated = sim_pars['p_rated'],
Nwt	=	175,
wind_MW_per_km2 = 4.782274215,
solar_MW =	500,
surface_tilt =	50,
surface_azimuth = 210,
DC_AC_ratio	= 1.5 ,
b_P = 100,
b_E_h=	1,
cost_of_battery_P_fluct_in_peak_price_ratio	=0.580645161,)

start = time.time()
outs = hpp.evaluate(**inputs)
hpp.print_design([v for k,v in inputs.items()], outs)
end = time.time()
print('exec. time [min]:', (end - start)/60 )
print(hpp.prob['NPV_over_CAPEX'])

wind_t = hpp.prob.get_val('ems.wind_t')
solar_t = hpp.prob.get_val('ems.solar_t')
hpp_t = hpp.prob.get_val('ems.hpp_t')
hpp_curt_t = hpp.prob.get_val('ems.hpp_curt_t')

n_days_plot = 14
plt.figure(figsize=[12,4])
plt.plot(wind_t[:24*n_days_plot], label='wind')
plt.plot(solar_t[:24*n_days_plot], label='PV')
plt.plot(hpp_t[:24*n_days_plot], label='HPP')
plt.plot(hpp_curt_t[:24*n_days_plot], label='HPP curtailed')
plt.xlabel('time [hours]')
plt.ylabel('Power [MW]')
plt.legend(loc='upper center', bbox_to_anchor=(0.5, 1.15),
           ncol=5, fancybox=0, shadow=0)

from hopp.simulation import HoppInterface

hi = HoppInterface(os.path.join(os.getcwd(), "hopp_input/hopp_config.yaml"))

hi.simulate(25)

hybrid_plant = hi.system

annual_energies = hybrid_plant.annual_energies
npvs = hybrid_plant.net_present_values
cf = hybrid_plant.capacity_factors

wind_installed_cost = hybrid_plant.wind.total_installed_cost
solar_installed_cost = hybrid_plant.pv.total_installed_cost
battery_installed_cost = hybrid_plant.battery.total_installed_cost
hybrid_installed_cost = hybrid_plant.grid.total_installed_cost

print("Wind Installed Cost [M$]: {}".format(wind_installed_cost/1e6))
print("Solar Installed Cost [M$]: {}".format(solar_installed_cost/1e6))
print("Battery Installed Cost [M$]: {}".format(battery_installed_cost/1e6))
print("Hybrid Installed Cost [M$]: {}\n".format(hybrid_installed_cost/1e6))

print("Wind NPV [M$]: {}".format(hybrid_plant.net_present_values.wind/1e6))
print("Solar NPV [M$]: {}".format(hybrid_plant.net_present_values.pv/1e6))
print("Hybrid NPV [M$]: {}\n".format(hybrid_plant.net_present_values.hybrid/1e6))

print("Annual Energies [kW]",annual_energies)
print("Capacity Factors",cf)
print("NPV [$]", npvs)

print("LCOE [cents/kWh]", hybrid_plant.lcoe_real,"\n")

print(hybrid_plant.lcoe_real['hybrid'])
print("Hybrid LCOE [$/MWh]", hybrid_plant.lcoe_real['hybrid']*10)

import json

with open("singleowner.json", 'w') as f:
    dat = hybrid_plant.grid._financial_model.export()
    d = dict()
    for k, v in dat.items():
        d.update(v)
    json.dump(d, f)

euro_per_dollar = 1.0
df = pd.DataFrame({'HOPP': [wind_installed_cost/1e6*euro_per_dollar,
                            solar_installed_cost/1e6*euro_per_dollar,
                            battery_installed_cost/1e6*euro_per_dollar,
                            hybrid_installed_cost/1e6*euro_per_dollar,
                            hybrid_plant.net_present_values.hybrid/1e6*euro_per_dollar,
                           ],
                   'HyDesign': [float(hpp.prob['wpp_cost.CAPEX_w']/1e6),
                                float(hpp.prob['pvp_cost.CAPEX_s']/1e6),
                                float(hpp.prob['battery_cost.CAPEX_b']/1e6),
                                float(hpp.prob['CAPEX']/1e6),
                                float(hpp.prob['NPV']/1e6),
                                ] },
                  index=['CAPEX Wind [M€]',
                         'CAPEX Solar [M€]',
                         'CAPEX Battery [M€]',
                         'CAPEX Hybrid [M€]',
                         'NPV Hybrid [M€]',
                        ])

df

hpp.prob.model.list_outputs()